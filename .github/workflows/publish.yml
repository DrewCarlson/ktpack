name: Publish Release

on:
  push:
    tags: [ 'v*' ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  publish-docs:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true
          fetch-depth: 0

      - name: Cache Build files
        uses: actions/cache@v3
        with:
          path: |
            ~/.konan
            ~/.gradle
          key: ${{ runner.os }}-${{ hashFiles('gradle.properties') }}

      - name: Configure Git user
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: 11

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'
          architecture: x64
          cache: 'pip'
          cache-dependency-path: 'docs/requirements.txt'

      - name: Install Python dependencies
        run: python3 -m pip install -r ./docs/requirements.txt

      - uses: gradle/gradle-build-action@v2
        name: Build KDocs
        with:
          arguments: clean dokkaHtmlMultiModule

      - name: Move KDoc build
        run: mv build/dokka/htmlMultiModule docs/kdoc

      - name: Deploy with mike
        run: |
          VERSION_WITH_V=${{ github.ref_name }}
          VERSION=${VERSION#v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          mike deploy --push $VERSION_WITH_V latest

  publish-ktpack-script:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    needs: [ file-changes ]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          submodules: 'recursive'

      - uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: 11

      - name: Cache Build files
        uses: actions/cache@v3
        with:
          path: |
            ~/.konan
            ~/.gradle
          key: ${{ runner.os }}-${{ hashFiles('gradle.properties') }}-v2

      - uses: gradle/gradle-build-action@v2
        name: Build CLI
        with:
          arguments: :ktpack-script:shadowJar

      - name: Compress and checksum
        run: |
          mv ktpack-script/build/libs/ktpack-script.jar ktpack-script.jar
          shasum -a 256 ktpack-script.jar > ktpack-script.jar.sha256

      - name: Upload to Github Release
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          prerelease: ${{ contains(github.ref, '-') }}
          draft: ${{ !startsWith(github.ref, 'refs/tags/v') }}
          files: |
            ktpack-script.jar
            ktpack-script.jar.sha256

  publish-cli-windows:
    runs-on: windows-latest
    permissions:
      contents: write
      packages: write
    needs: [ file-changes ]
    steps:
      - uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-clang
      - name: Disable Visual Studio
        run: move "C:\Program Files\Microsoft Visual Studio" "C:\Program Files\Microsoft Visual Studio2"
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          submodules: 'recursive'

      - uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: 11

      - name: Cache Build files
        uses: actions/cache@v3
        with:
          path: |
            %USERPROFILE%\.konan
            %USERPROFILE%\.gradle
          key: ${{ runner.os }}-${{ hashFiles('gradle.properties') }}-v2

      - uses: gradle/gradle-build-action@v2
        name: Build CLI
        with:
          arguments: packageReleaseWindows

      - name: Upload to Github Release
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          prerelease: ${{ contains(github.ref, '-') }}
          draft: ${{ !startsWith(github.ref, 'refs/tags/v') }}
          files: |
            ktpack/build/release/ktpack-windows.zip
            ktpack/build/release/ktpack-windows.zip.sha256

  publish-cli-linux:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    needs: [ file-changes ]
    steps:
      - name: Install libcurl
        run:  |
          sudo apt update
          sudo apt install libcurl4-openssl-dev

      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          submodules: 'recursive'

      - uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: 11

      - name: Cache Build files
        uses: actions/cache@v3
        with:
          path: |
            ~/.konan
            ~/.gradle
          key: ${{ runner.os }}-${{ hashFiles('gradle.properties') }}-v2

      - uses: gradle/gradle-build-action@v2
        name: Build CLI
        with:
          arguments: packageReleaseLinux

      - name: Upload to Github Release
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          prerelease: ${{ contains(github.ref, '-') }}
          draft: ${{ !startsWith(github.ref, 'refs/tags/v') }}
          files: |
            ktpack/build/release/ktpack-linux.zip
            ktpack/build/release/ktpack-linux.zip.sha256

  publish-cli-macos:
    runs-on: macos-latest
    permissions:
      contents: write
      packages: write
    needs: [ file-changes ]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          submodules: 'recursive'

      - uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: 11

      - name: Cache Build files
        uses: actions/cache@v3
        with:
          path: |
            ~/.konan
            ~/.gradle
          key: ${{ runner.os }}-${{ hashFiles('gradle.properties') }}-v2

      - uses: gradle/gradle-build-action@v2
        name: Build CLI
        with:
          arguments: packageReleaseMacos --no-parallel

      - name: Upload to Github Release
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          prerelease: ${{ contains(github.ref, '-') }}
          draft: true
          files: |
            ktpack/build/release/ktpack-macos.zip
            ktpack/build/release/ktpack-macos.zip.sha256
